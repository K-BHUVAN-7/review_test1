<div class="container-fluid">

    <div class="d-flex justify-content-between mb-3">

        <h5 class="text-dark">{{ mode | titlecase}} Units</h5>

        <small> <span class="text-primary">Units</span> <img src="images/breadcrumbs.png" alt="" style="width: 16px;" class="ms-1 me-1"> <span class="text-primary" style="cursor: pointer;" (click)="this.service.navigate({ 'url': 'app/units' });">Units List</span> <img src="images/breadcrumbs.png" alt="" style="width: 16px;" class="ms-1 me-1"> <span class="text-dark"> {{ this.mode == 'Create' ? 'Create' : 'Update' }} Unit</span> </small>

    </div>

    <div class="row" [formGroup]="unitForm">

        <!-- Unit Details & Expected Rent -->
        <div class="col-md-8">

            <!-- Unit Details -->
            <div class="card border-0" style="box-shadow: 0 0 2px 2px rgba(0, 0, 0, 0.051);">

                <div class="card-header bg-white">
    
                    <div class="d-flex justify-content-between align-items-center " style="height: 40px;">
    
                        <h6 class="ps-2 my-0" style="font-weight: 600; border-left: 3px solid #D2A119;">Unit Details :</h6>
                    
                    </div>
                    
                </div>

                <div class="card-body">

                    <div class="row">

                        <div class="col-md-6 form-group required mb-3">

                            <label for="" class="mb-2">Property Name</label>

                            <ng-container *ngIf="this.mode == 'Create'; else other">

                                <ng-select class="form-control" id="zpropertyName" formControlName="propertyName" placeholder="Select Property" [ngClass]="{ 'is-invalid': (f.propertyName?.touched || formSubmitted) && f.propertyName.errors }" (change)="changeValue({fieldName: 'propertyName'})" appendTo="body" [clearable]="false">

                                    <ng-option *ngFor="let item of this.masterList['propertyList']" [value]="item._id">{{ item.propertyName }}</ng-option>

                                </ng-select>

                            </ng-container>

                            <ng-template #other>

                                <input type="text" class="form-control" formControlName="propertyName" [value]="this.editData.propertyName?.propertyName" [readOnly]="this.mode == 'Update'">

                            </ng-template>

                            <div *ngIf="(f.propertyName?.touched || formSubmitted) && f.propertyName.errors" class="invalid-feedback">
        
                                <div *ngIf="f.propertyName.errors.required">Property Name is required</div>
        
                            </div>

                        </div>

                        <div class="col-md-6 form-group required mb-3">

                            <label for="unitName" class="mb-2">Unit Name </label>

                            <input type="text" class="form-control" id="unitName" formControlName="unitName" placeholder="Enter Unit Name" [ngClass]="{ 'is-invalid': (f.unitName?.touched || formSubmitted) && f.unitName.errors }">

                            <div *ngIf="(f.unitName?.touched || formSubmitted) && f.unitName.errors" class="invalid-feedback">
        
                                <div *ngIf="f.unitName.errors.required">Unit Name is required</div>
        
                            </div>

                        </div>

                        <div class="col-md-6 form-group required mb-3">

                            <label for="countOfBedrooms" class="mb-2">Count of Bedrooms</label>

                            <input type="text" class="form-control" id="countOfBedrooms" formControlName="countOfBedrooms" placeholder="--" numbersOnly [ngClass]="{ 'is-invalid': (f.countOfBedrooms?.touched || formSubmitted) && f.countOfBedrooms.errors }">

                            <div *ngIf="(f.countOfBedrooms?.touched || formSubmitted) && f.countOfBedrooms.errors" class="invalid-feedback">
        
                                <div *ngIf="f.countOfBedrooms.errors.required">Count of Bedrooms is required</div>
        
                            </div>

                        </div>

                        <div class="col-md-6 form-group required mb-3">

                            <label for="furnishing" class="mb-2">Furnishing</label>

                            <ng-select name="furnishing" id="furnishing" class="form-control" formControlName="furnishing" placeholder="Select Furnishing" [ngClass]="{ 'is-invalid': (f.furnishing?.touched || formSubmitted) && f.furnishing.errors }" appendTo="body" [clearable]="false">

                                <ng-option *ngFor="let furn of furnishingList" [value]="furn.name">{{ furn?.name }}</ng-option>

                            </ng-select>

                            <div *ngIf="(f.furnishing?.touched || formSubmitted) && f.furnishing.errors" class="invalid-feedback">
        
                                <div *ngIf="f.furnishing.errors.required">Furnishing is required</div>
        
                            </div>

                        </div>

                        <div class="col-md-6 form-group required mb-3">

                            <label for="propertyType" class="mb-2">Property Type</label>

                            <ng-select class="form-control" id="propertyType" formControlName="propertyType" placeholder="Select Property Type" [ngClass]="{ 'is-invalid': (f.propertyType?.touched || formSubmitted) && f.propertyType.errors }" appendTo="body" [clearable]="false">

                                <ng-option *ngFor="let item of filteredPropertyTypeList" [value]="item._id">{{ item.propertyName }}</ng-option>

                            </ng-select>

                            <div *ngIf="(f.propertyType?.touched || formSubmitted) && f.propertyType.errors" class="invalid-feedback">
        
                                <div *ngIf="f.propertyType.errors.required">Property Type is required</div>
        
                            </div>

                        </div>

                    </div>

                </div>

            </div>

            <!-- Expected Rent -->
            <div class="card border-0 mt-3" style="box-shadow: 0 0 2px 2px rgba(0, 0, 0, 0.051); height: 220px;">

                <div class="card-header bg-white">
    
                    <div class="d-flex justify-content-between align-items-center " style="height: 40px;">
    
                        <h6 class="ps-2 my-0" style="font-weight: 600; border-left: 3px solid #D2A119 ;">Expected Rent:</h6>
                    
                    </div>
                    
                </div>

                <div class="card-body">

                    <div class="row">

                        <div class="col-md-6 form-group  mb-3">

                            <label for="rentalAmt" class="mb-2">Rental Amount</label>

                            <input type="text" class="form-control" placeholder="Enter Rent Amount" formControlName="rentalAmt" numbersOnly>
                            
                        </div>
                        
                        <div class="col-md-6 form-group  mb-3">
                            
                            <label for="depositAmt" class="mb-2">Deposit Amount</label>
                            
                            <input type="text" class="form-control" placeholder="Enter Deposit Amount" formControlName="depositAmt" numbersOnly>

                        </div>

                    </div>

                </div>

            </div>

        </div>
 
        <!-- Upload Images & Contract Details Documents -->
        <div class="col-md-4">

            <!-- unit Image Upload -->
            <div class="card border-0" style="box-shadow: 0 0 2px 2px rgba(0, 0, 0, 0.051); height: 346px;">

                <div class="card-header bg-white d-flex justify-content-between">
    
                    <div class="d-flex justify-content-between align-items-center" style="height: 40px;">
        
                        <h6 class="ps-2 my-0" style="font-weight: 600; border-left: 3px solid #D2A119;">Upload Unit Images : </h6>
                        
                    </div>

                    <div (click)="shareImage()" style="cursor: pointer;">

                        <img src="images/icons/share-icon.svg" class="mt-2" style="width: 27px;" alt="">

                    </div>
                        
                </div>

                <div class="card-body">

                    <div class="upload-container">
                    
                        <label class="upload-box" (dragover)="onDragOver($event)"
                        (dragleave)="onDragLeave($event)"
                        (drop)="onDrop($event)"
                        [class.dragover]="isDragOver">
                        
                            <input type="file" (change)="onFileSelect($event)" multiple hidden />
                        
                            <img src="images/uploadImg.png" class="mb-2"  style="width: 50px;" alt="">
                        
                            <div class="upload-content">
                        
                                <p class="my-0">Drag and Drop or <span class="browse">Browse</span></p>
                        
                                <small class="text-muted">File Supported: Png, Jpg</small>
                        
                            </div>
                        
                        </label>
        
                        <div class="upload-scroll-area">
        
                            <div *ngFor="let file of uploadFiles; let i = index" class="upload-list">
        
                                <!-- <img class="thumbnail" [src]="file.preview" (click)="openPreview(file.preview)" alt="Preview" /> -->

                                  <ng-container [ngSwitch]="getFileType(file.file.name)">
                                        
                                        <img *ngSwitchCase="'pdf'" class="thumbnail" src="images/pdf.png" alt="PDF" (click)="openPreview(file.preview )" />

                                        <a *ngSwitchCase="'word'" [href]="file.preview" [download]="file.file.name">

                                            <img class="thumbnail" src="images/word2.png" alt="Word" />

                                        </a>

                                        <!-- <img *ngSwitchCase="'word'" class="thumbnail" src="images/word2.png" alt="Word"  /> -->

                                        <img *ngSwitchDefault class="thumbnail" [src]="file.preview" alt="Preview" (click)="openPreview(file.preview)" />
                                        
                                    </ng-container>
        
                                <div class="file-info">
        
                                    <p>{{ file.file.name }}</p>
        
                                    <p [class.completed]="file.status == 'Ready to upload'">{{ file.status }}</p>
        
                                    <div class="progress-bar">
        
                                        <div class="progress" [style.width.%]="file.progress" [class.completed]="file.status == 'Ready to upload'"></div>
        
                                    </div>
        
                                </div>
        
                                <button class="closebutton" (click)="removeImage(i)">✖</button>
        
                            </div>
        
                        </div>
        
                    </div>
                    
                </div>

            </div>
          
            <!-- Contract Detail Documents -->
            <div class="card border-0 mt-3" style="box-shadow: 0 0 2px 2px rgba(0, 0, 0, 0.051); height: 220px;">

                <div class="card-header bg-white d-flex justify-content-between">
    
                    <div class="d-flex justify-content-between align-items-center" style="height: 40px;">
        
                        <h6 class="ps-2 my-0" style="font-weight: 600; border-left: 3px solid #D2A119;">Contract Upload Documents : </h6>
                        
                    </div>

                    <div (click)="shareContractDocuments()" style="cursor: pointer;">

                        <img src="images/icons/share-icon.svg" class="mt-2" style="width: 27px;" alt="">

                    </div>
                        
                </div>

                <div class="card-body">

                    <div class="upload-container mt-0 pt-0">
                    
                        <label class="upload-box mt-0 pt-1 pb-1 mb-0" style="height: 60px !important;" (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)" (drop)="onDrop($event,'contract')"
                        [class.dragover]="isDragOver">
                        
                            <input type="file" (change)="onPdfSelect($event)" multiple hidden />
                            
                            <div class="upload-content d-flex justify-content-center">

                                <img src="images/uploadImg.png" class="me-4" style="width: 40px; height: 40px;" alt="">
                                 
                                <div>

                                    <small class="my-0">Drag and Drop or <span class="browse">Browse</span></small> <br>

                                    <small class="text-muted">File Supported: Png, Jpg</small>

                                </div>
                        
                            </div>

                        
                        </label>
        
                        <div class="upload-scroll-area">
        
                            <div *ngFor="let contract of contractFiles; let i = index" class="upload-list">
        
                                <!-- <img class="thumbnail" src="/images/pdf.png" (click)="openPreview(contract.preview)" alt="Preview" /> -->
                                
                                  <ng-container [ngSwitch]="getFileType(contract.file.name)">
                                        
                                        <img *ngSwitchCase="'pdf'" class="thumbnail" src="images/pdf.png" alt="PDF" (click)="openPreview(contract.preview )" />

                                        <a *ngSwitchCase="'word'" [href]="contract.preview" [download]="contract.file.name">

                                            <img class="thumbnail" src="images/word2.png" alt="Word" />

                                        </a>

                                        <!-- <img *ngSwitchCase="'word'" class="thumbnail" src="images/word2.png" alt="Word"  /> -->

                                        <img *ngSwitchDefault class="thumbnail" [src]="contract.preview" alt="Preview" (click)="openPreview(contract.preview)" />
                                        
                                    </ng-container>
        
                                <div class="file-info">
        
                                    <p>{{ contract.file.name }}</p>
        
                                    <p [class.completed]="contract.status == 'Ready to upload'">{{ contract.status }}</p>
        
                                    <div class="progress-bar">
        
                                        <div class="progress" [style.width.%]="contract.progress" [class.completed]="contract.status == 'Ready to upload'"></div>
        
                                    </div>
        
                                </div>
        
                                <button class="closebutton" (click)="removeContractFile(i)">✖</button>
        
                            </div>
        
                        </div>
        
                    </div>
                    
                </div>

            </div>

        </div>

        <!-- Furniture Included -->
        <div class="col-md-12">

            <div class="card border-0 mt-3" style="box-shadow: 0 0 2px 2px rgba(0, 0, 0, 0.051);">

                <div class="card-header bg-white">
    
                    <div class="d-flex justify-content-between align-items-center " style="height: 40px;">
      
                        <h6 class="ps-2 my-0" style="font-weight: 600; border-left: 3px solid #D2A119;">Furniture Included : </h6>
                      
                    </div>
                      
                </div>
    
                <div class="card-body p-0">
    
                    <div class="table-responsive" formArrayName="furnitureIncluded">

                        <table class="table table-borderless align-middle table-striped">

                            <thead class="bg-light text-secondary">

                                <tr>

                                    <th>Action</th>

                                    <th>Item</th>

                                    <th>Count</th>

                                    <th>Condition</th>

                                    <th style="text-align: center !important;">Usage</th>

                                </tr>

                            </thead>
                        
                            <tbody>

                                <ng-container *ngFor="let item of f.furnitureIncluded.controls; let i = index; let last = last; let first = first">

                                    <ng-container [formGroup]="item" *ngIf="item.controls as fif">

                                        <tr>

                                            <td>

                                                <div class="d-flex justify-content-between align-items-center" style="height: 100%;">

                                                    <p (click)="deleteFurnitureItem(i)" style="color: #FF4949 !important; font-size: 18px; cursor: pointer; margin: 0; display: flex; align-items: center;">

                                                        <i class="bi bi-dash-lg fw-bold"></i>
                                                    
                                                    </p>
                                                
                                                    <p *ngIf="last" (click)="addFurnitureItem(i)" class="fw-bold" style="cursor: pointer; margin: 0; display: flex; align-items: center;">

                                                        <i class="bi bi-plus-lg fw-bold"></i>

                                                    </p>

                                                </div>

                                            </td>

                                            <td>
                                            
                                                <input type="text" class="form-control" id="item" placeholder="Enter Item" formControlName="item" [ngClass]="{ 'is-invalid': (fif.item?.touched || formSubmitted) && fif.item?.errors }">

                                            </td>

                                            <td>
                                            
                                                <input type="number" class="form-control" placeholder="Enter Count" formControlName="count" numbersOnly [ngClass]="{ 'is-invalid': (fif.count?.touched || formSubmitted) && fif.count?.errors }">

                                            </td>

                                            <td>
                                            
                                                <input type="text" class="form-control" placeholder="Enter Condition" formControlName="condition" [ngClass]="{ 'is-invalid': (fif.condition?.touched || formSubmitted) && fif.condition?.errors }">

                                            </td>

                                            <td>
                                            
                                                <input type="text" class="form-control" placeholder="Enter Usage" formControlName="usage" [ngClass]="{ 'is-invalid': (fif.usage?.touched || formSubmitted) && fif.usage?.errors }">

                                            </td>

                                        </tr>

                                    </ng-container>

                                </ng-container>

                            </tbody>

                        </table>

                    </div>
    
                </div>
    
            </div>

        </div>

        <!-- Contract history List Table -->
        <div class="col-md-12" *ngIf="this.mode == 'Update'">

            <div class="card border-0 mt-3" style="box-shadow: 0 0 2px 2px rgba(0, 0, 0, 0.051);">

                <div class="card-header bg-white">
                            
                    <div class="d-flex justify-content-between align-items-center " style="height: 40px;">
        
                        <h6 class="ps-2 my-0" style="font-weight: 600; border-left: 3px solid #D2A119 ;">Contract History : </h6>
                        
                    </div>
                        
                </div>
    
                <div class="card-body p-0">
    
                    <div class="table-responsive">

                        <table class="table table-borderless align-middle table-striped">
    
                            <thead class="bg-light text-secondary">
    
                                <tr>
    
                                    <th style="min-width: 150px;">Tenant</th>

                                    <th style="min-width: 80px;">Id</th>
                                    
                                    <th style="min-width: 90px;">Charge Type</th>
                                    
                                    <th style="min-width: 80px;">Rental Type</th>
                                    
                                    <th style="min-width: 80px;">Frequency</th>

                                    <th style="min-width: 60px;">Due Day</th>

                                    <th style="min-width: 80px;">Next Due Day</th>

                                    <th style="min-width: 80px;">Rent Amount</th>

                                    <th style="min-width: 80px;">Deposit Amount</th>

                                    <th style="min-width: 80px;">Start Date</th>
                                    
                                    <th style="text-align: center !important; min-width: 210px !important;" class="th-action">End Date</th>

                                </tr>
    
                            </thead>
                        
                            <tbody>

                                <ng-container *ngIf="!_.isEmpty(this.masterList['contractList']) ;else other">
    
                                    <ng-container *ngFor="let contract of this.masterList['contractList']; let i = index; let last = last; let first = first">
        
                                        <tr>
                                            
                                            <td class="td-first-field" [matTooltip]="contract.tenantId?.firstName || '-'" matTooltipPosition="above" matTooltipClass="custom-tooltip">

                                                <span>{{ (contract.tenantId?.firstName || '-').length > 20 ? (contract.tenantId?.firstName || '-').slice(0, 20) + '...' : (contract.tenantId?.firstName || '-') }}</span>

                                            </td>

                                            <!-- <td>{{ contract.tenantId?.firstName | titlecase}}</td> -->

                                            <td>{{ contract.govtId }}</td>

                                            <td>{{ contract.chargeType }}</td>

                                            <td>{{ contract.rentalType }}</td>

                                            <td>{{ contract.frequency }}</td>

                                            <td style="text-align: center !important;">{{ contract.dueDay }}</td>

                                            <td>{{ contract.nextDueDay | date: 'dd-MM-yyyy' }}</td>

                                            <td>{{ this.service.currencyCode?.currencyCode }}. {{ contract.rentalAmt | number: '1.0' }}</td>

                                            <td>{{ this.service.currencyCode?.currencyCode }}. {{ contract.depositAmt | number: '1.0' }}</td>

                                            <td>{{ contract.contractStartDate | date: 'dd-MM-yyyy' }}</td>

                                            <td style="text-align: center !important; min-width: 210px !important;">{{ contract.contractEndDate | date: 'dd-MM-yyyy' }}</td>

                                        </tr>
            
                                    </ng-container>

                                </ng-container>

                                <ng-template #other>

                                    <tr>

                                        <td colspan="12" style="text-align: center !important;">No Records Found</td>

                                    </tr>

                                </ng-template>
    
                            </tbody>

                        </table>

                    </div>
    
                </div>
    
            </div>

        </div>

        <!-- Rental List Table -->
        <div class="col-md-12" *ngIf="this.mode == 'Update'">

            <div class="card border-0 mt-3" style="box-shadow: 0 0 2px 2px rgba(0, 0, 0, 0.051);">

                <div class="card-header bg-white">
                            
                    <div class="d-flex justify-content-between align-items-center " style="height: 40px;">
        
                        <h6 class="ps-2 my-0" style="font-weight: 600; border-left: 3px solid #D2A119 ;">Rental List : </h6>
                        
                    </div>
                        
                </div>
    
                <div class="card-body p-0">
    
                    <div class="table-responsive">

                        <table class="table table-borderless align-middle table-striped">
    
                            <thead class="bg-light text-secondary">
    
                                <tr>

                                    <th>Tenant</th>
    
                                    <th>Bill Date</th>

                                    <th>Due Date</th>
                                    
                                    <th>Rent</th>
                                    
                                    <th>Paid Amount</th>
                                    
                                    <th>Rent Outstanding</th>

                                    <th>Status</th>

                                    <th style="text-align: center !important; min-width: 210px !important;" class="th-action">Action</th>

                                </tr>
    
                            </thead>
                        
                            <tbody>

                                <ng-container *ngIf="!_.isEmpty(this.editData.tenantId?.rentList) ;else other">
    
                                    <ng-container *ngFor="let rental of this.editData.tenantId?.rentList; let i = index; let last = last; let first = first">
        
                                        <tr>

                                            <td [matTooltip]="this.editData.tenantId?.firstName || '-'" matTooltipPosition="above" matTooltipClass="custom-tooltip">

                                                <span>{{ (this.editData.tenantId?.firstName || '-').length > 20 ? (this.editData.tenantId?.firstName || '-').slice(0, 20) + '...' : (this.editData.tenantId?.firstName || '-') }}</span>

                                            </td>

                                            <td>{{ rental?.billDate | date: 'dd-MM-yyyy' }}</td>

                                            <td>{{ rental?.dueDate | date: 'dd-MM-yyyy' }}</td>

                                            <td>{{ this.service.currencyCode?.currencyCode }}. {{ (rental?.amountDue | number: '1.0') || '0' }}</td>

                                            <td>{{ this.service.currencyCode?.currencyCode }}. {{ (rental?.amountPaid | number: '1.0') || '0' }}</td>
                                            
                                            <td>{{ this.service.currencyCode?.currencyCode }}. {{ (rental?.amountDue - rental?.amountPaid) | number: '1.0' }}</td>

                                            <td class="td-status">

                                                <ng-container [ngSwitch]="getRentStatus(rental)">

                                                    <font *ngSwitchCase="'Upcoming'" color="#FF9500">Upcoming</font>

                                                    <font *ngSwitchCase="'Overdue'" color="#C92E2E">Overdue</font>

                                                    <font *ngSwitchCase="'Not yet Due'" color="#FF9500">Not yet Due</font>

                                                    <font *ngSwitchCase="'Paid'" color="#34C759">Paid</font>

                                                    <font *ngSwitchCase="'Free'" color="#34C759">Free</font>

                                                    <font *ngSwitchDefault>-</font>

                                                </ng-container>
                                                
                                            </td>
                                            
                                            <td class="d-flex justify-content-center th-action">

                                                <img src="images/icons/history-outline.svg" class="me-3" style="width: 26px; height: auto; cursor: pointer;" alt="" (click)="openHistoryModal(rental)" />

                                            </td>

                                        </tr>
            
                                    </ng-container>

                                </ng-container>

                                <ng-template #other>

                                    <tr>

                                        <td colspan="10" style="text-align: center !important;">No Records Found</td>

                                    </tr>

                                </ng-template>
    
                            </tbody>

                        </table>

                    </div>
    
                </div>
    
            </div>

        </div>

        <!-- Select Issue Configuration -->
        <div class="col-md-12">

            <div class="card border-0 mt-3" style="box-shadow: 0 0 2px 2px rgba(0, 0, 0, 0.051);">

                <div class="card-header bg-white">
    
                    <div class="d-flex justify-content-between align-items-center " style="height: 40px;">
      
                        <h6 class="ps-2 my-0" style="font-weight: 600; border-left: 3px solid #D2A119;">Issues Configuration : </h6>
                      
                    </div>
                      
                </div>
    
                <div class="card-body p-0">
    
                    <div class="table-responsive" formArrayName="issueConfiguration">

                        <table class="table table-borderless align-middle table-striped">

                            <thead class="bg-light text-secondary">

                                <tr>

                                    <th style="width: 6%">Action</th>

                                    <th style="width: 15%">Issue Category</th>

                                    <th style="width: 15%">Priority</th>

                                    <th style="width: 15%">TAT</th>

                                    <th style="width: 20%">Staff</th>

                                    <th style="width: 20%; text-align: center !important;">Managers</th>

                                </tr>

                            </thead>
                        
                            <tbody>

                                <ng-container *ngFor="let config of f.issueConfiguration.controls; let i = index; let last = last; let first = first">

                                    <ng-container [formGroup]="config" *ngIf="config.controls as cdf">

                                        <tr>

                                            <td>

                                                <div class="d-flex justify-content-between align-items-center" style="height: 100%;">

                                                    <p (click)="deleteConfigurationItem(i)" style="color: #FF4949 !important; font-size: 18px; cursor: pointer; margin: 0; display: flex; align-items: center;">

                                                        <i class="bi bi-dash-lg fw-bold"></i>
                                                    
                                                    </p>
                                                
                                                    <p *ngIf="last" (click)="addConfigurationItem(i)" class="fw-bold" style="cursor: pointer; margin: 0; display: flex; align-items: center;">

                                                        <i class="bi bi-plus-lg fw-bold"></i>

                                                    </p>

                                                </div>

                                            </td>

                                            <td>
                                            
                                                <ng-select class="form-control" formControlName="issueCategory" placeholder="Select Issue" id="issueCategory" (change)="changeValue({fieldName: 'issueCategory'})" [ngClass]="{ 'is-invalid': (cdf.issueCategory?.touched || formSubmitted) && cdf.issueCategory?.errors }" appendTo="body" [clearable]="false">

                                                    <ng-container *ngFor="let issue of masterList['issueList']">

                                                        <ng-option [value]="issue._id">{{ issue.issueName }}</ng-option>

                                                      </ng-container>
                                                      
                                                </ng-select>

                                            </td>

                                            <td>

                                                <ng-select name="" id="priority" class="form-control" formControlName="priority" placeholder="Select Priority" autocomplete="off" [ngClass]="{ 'is-invalid': (cdf.priority?.touched || formSubmitted) && cdf.priority?.errors }" appendTo="body" [clearable]="false">

                                                    <ng-option value="hight">High</ng-option>

                                                    <ng-option value="medium">Medium</ng-option>

                                                    <ng-option value="low">Low</ng-option>
                                                    
                                                </ng-select>

                                            </td>

                                            <td>

                                                <!-- <div class="w-100 d-flex">

                                                    <input type="text" class="form-control" id="tat" formControlName="tat" numbersOnly>

                                                    <input type="text" class="form-control ms-1" id="tatType" formControlName="tatType"> 

                                                </div> -->

                                                <div class="d-flex w-100">

                                                    <div class="col-md-5" >

                                                        <input type="number" class="form-control" id="tat" formControlName="tat" numbersOnly autocomplete="off" placeholder="-" [ngClass]="{ 'is-invalid': (cdf.tat?.touched || formSubmitted) && cdf.tat?.errors }"/>
                                                        
                                                    </div>
                                                
                                                    <div class="col-md-6">

                                                        <ng-select name="tatType" id="tatType" formControlName="tatType" class="form-control" placeholder="Select Type" [ngClass]="{ 'is-invalid': (cdf.tatType?.touched || formSubmitted) && cdf.tatType?.errors }" appendTo="body" [clearable]="false">

                                                            <ng-option value="days">Days</ng-option>
                                                            
                                                            <ng-option value="hours">Hours</ng-option>
                                                            
                                                        </ng-select>
                                                    
                                                    </div>
                                                    
                                                </div>
                                                
                                            </td>

                                            <td>

                                                <ng-select class="form-control" [items]="config.get('staffList')?.value || []" bindLabel="staff" bindValue="_id" formControlName="staff" [multiple]="true" placeholder="Select Staff" [closeOnSelect]="false" [clearable]="false" [virtualScroll]="true" [searchable]="true" appendTo="body">

                                                    <ng-template ng-multi-label-tmp let-items="items" let-clear="clear">

                                                        <div class="ng-value multiple" *ngFor="let item of items | slice: 0 : 1">
                                                            
                                                            <div class="d-flex">

                                                                <span class="ng-value-label ellipsis ms-1">

                                                                    <span>{{ _.get(item,'firstName') + ' ' + _.get(item,'lastName') }}</span> 

                                                                </span>

                                                                <span (click)="clear(item)" class="ms-2 me-1 fs-6 fw-200" style="cursor: pointer;">&times;</span>

                                                                <span style="width: 1px; height: 20px; background-color: black;"></span>
                                                                
                                                            </div>

                                                        </div>

                                                        <div class="ng-value multiple ms-2" *ngIf="items.length > 1">

                                                            <span class="ng-value-label ellipsis"> + {{ items.length - 1 }} more</span>

                                                        </div>

                                                    </ng-template>   

                                                    <ng-template class="mt-2" ng-option-tmp let-item="item" let-index="index">

                                                        <div class="form-check d-flex align-items-center"> 
                                                            
                                                            <input type="checkbox" class="form-check-input me-2" [checked]="isSelected(item._id, 'staff')"/>
                    
                                                            <label class="form-check-label mt-1">{{ item?.firstName + ' ' + item?.lastName }}</label>
                    
                                                        </div>
                                                            
                                                    </ng-template>
                                                
                                                </ng-select>

                                            </td>

                                            <td>

                                                <ng-select class="form-control" [items]="masterList['managerList']" bindLabel="manager" bindValue="_id" formControlName="manager" placeholder="Select Manager" [multiple]="true" [closeOnSelect]="false" [clearable]="false" [virtualScroll]="true" [searchable]="true" appendTo="body">

                                                    <ng-template ng-multi-label-tmp let-items="items" let-clear="clear">

                                                        <div class="ng-value multiple" *ngFor="let item of items | slice: 0 : 1">
                                                            
                                                            <div class="d-flex">

                                                                <span class="ng-value-label ellipsis ms-1">

                                                                    <span>{{ _.get(item,'firstName') + ' ' + _.get(item,'lastName') }}</span> 

                                                                </span>

                                                                <span (click)="clear(item)" class="ms-2 me-1 fs-6 fw-200" style="cursor: pointer;">&times;</span>

                                                                <span style="width: 1px; height: 20px; background-color: black;"></span>
                                                                
                                                            </div>

                                                        </div>

                                                        <div class="ng-value multiple ms-2" *ngIf="items.length > 1">

                                                            <span class="ng-value-label ellipsis"> + {{ items.length - 1 }} more</span>

                                                        </div>

                                                    </ng-template>    

                                                    <ng-template class="mt-2" ng-option-tmp let-item="item" let-index="index">

                                                        <div class="form-check d-flex align-items-center"> 
                                                            
                                                            <input type="checkbox" class="form-check-input me-2" [checked]="isSelected(item._id, 'manager')"/>
                    
                                                            <label class="form-check-label mt-1">{{ item?.firstName + ' ' + item?.lastName }}</label>
                    
                                                        </div>
                                                            
                                                    </ng-template>
                                                
                                                </ng-select>

                                            </td>

                                        </tr>

                                    </ng-container>

                                </ng-container>

                            </tbody>

                        </table>

                    </div>
    
                </div>
    
            </div>

        </div>

        <!-- Utilities Table -->
        <div class="row" *ngIf="this.mode == 'Update'">

            <div class="col-md-12">

                <div class="card border-0 mt-3" style="box-shadow: 0 0 2px 2px rgba(0, 0, 0, 0.051);">
    
                    <div class="card-header bg-white">

                        <div class="row">

                            <div class="col-md-6">

                                <div class="d-flex justify-content-between align-items-center " style="height: 40px;">
            
                                    <h6 class="ps-2 my-0" style="font-weight: 600; border-left: 3px solid #D2A119;">Utilities : </h6>
                                    
                                </div>

                            </div>

                            <div class="col-md-6 text-end mt-2">

                                <span>Total Utilitie Amount : {{ this.service.currencyCode?.currencyCode }}. {{ _.sumBy(filteredUtilityBill, 'utilityAmount') }}</span>

                            </div>
                            
                        </div>
                          
                    </div>
        
                    <div class="card-body p-0">
        
                        <div class="table-responsive">
    
                            <table class="table table-borderless align-middle table-striped">
    
                                <thead class="bg-light text-secondary">
        
                                    <tr>
        
                                        <th>Utility Name</th>
                                        
                                        <th>Due Date</th>
                                        
                                        <th>Payment Date</th>
                                        
                                        <th>Utility Amount</th>
                                        
                                        <th>Paid Amount</th>

                                        <th>Outstanding</th>
                                        
                                        <th>Invoice Number</th>

                                        <th>Status</th>

                                        <th style="text-align: center !important; min-width: 210px !important;" class="th-action">Action</th>

                                    </tr>
    
                                </thead>
                        
                                <tbody>

                                    <ng-container *ngIf="!_.isEmpty(filteredUtilityBill);else other">

                                        <ng-container *ngFor="let utility of filteredUtilityBill; let i = index; let last = last; let first = first">
            
                                            <tr>

                                                <td>{{ utility?.utility?.utilityName }}</td>

                                                <td>{{ (utility?.dueDate | date: 'dd-MM-yyyy') || '-' }}</td>

                                                <td>{{ (utility?.paymentDate | date: 'dd-MM-yyyy') || '-'  }}</td>
                                                
                                                <td>{{ this.service.currencyCode?.currencyCode }}. {{ utility?.utilityAmount | number: '1.0' }}</td>
                                                
                                                <td>{{ this.service.currencyCode?.currencyCode }}. {{ utility?.amountPaid | number: '1.0' }}</td>
                                                
                                                <td>{{ this.service.currencyCode?.currencyCode }}. {{ (utility?.utilityAmount - utility?.amountPaid) | number: '1.0' }}</td>
                                                
                                                <td>{{ utility?.invoiceNo }}</td>
                                                
                                                <td class="td-status">

                                                    <ng-container [ngSwitch]="getStatus(utility)">

                                                        <font *ngSwitchCase="'Overdue'" color="#C92E2E">Overdue</font>

                                                        <font *ngSwitchCase="'Upcoming'" color="#FFA500">Upcoming</font>

                                                        <font *ngSwitchCase="'Not yet Due'" color="#FF9500">Not yet Due</font>

                                                        <font *ngSwitchCase="'Paid'" color="#34C759">Paid</font>

                                                        <font *ngSwitchDefault>-</font>

                                                    </ng-container>

                                                </td>

                                                <td class="d-flex justify-content-center th-action">
                
                                                    <div class="d-flex justify-content-between align-items-center" style="height: 100%;">
                
                                                        <ng-container *ngIf="getStatus(utility) != 'Paid'; else notPay">

                                                            <button class="payment-button btn btn-sm fw-500" style="cursor: pointer;" (click)="openUtilityAmtModal(utility?._id)">Pay</button>

                                                        </ng-container>

                                                        <ng-template #notPay>

                                                            -

                                                        </ng-template>

                                                    </div>
            
                                                </td>
            
                                            </tr>
                
                                        </ng-container>
                                        
                                    </ng-container>

                                        <ng-template #other>

                                            <tr>

                                                <td colspan="10" style="text-align: center !important;">No  Records Found</td>

                                            </tr>

                                        </ng-template>
    
                                </tbody>
    
                            </table>
    
                        </div>
        
                    </div>
        
                </div>
    
            </div>

        </div>
 
        <!-- Property Tax -->
        <!-- <div class="col-md-12">

            <div class="card border-0 mt-3" style="box-shadow: 0 0 2px 2px rgba(0, 0, 0, 0.051);">

                <div class="card-header bg-white">
    
                    <div class="d-flex justify-content-between align-items-center " style="height: 40px;">
      
                        <h6 class="ps-2 my-0" style="font-weight: 600; border-left: 3px solid #D2A119;">Property Tax : </h6>
                      
                    </div>
                      
                </div>
    
                <div class="card-body p-0" formGroupName="propertyTax">

                    <ng-container>
    
                        <div class="col-md-8 ms-2 d-flex mt-3">

                            <div class="col-md-4 ms-2">

                                <div class="form-group mb-3">

                                    <label for="propertyTaxAmt" class="mb-2">Amount</label>

                                    <input type="text" class="form-control" id="propertyTaxAmt" [readOnly]="this.mode == 'Update'" formControlName="propertyTaxAmt" placeholder="" placeholder="Enter Amount" numbersOnly [ngClass]="{ 'is-invalid': (formSubmitted || unitForm.get('propertyTax')?.get('propertyTaxAmt')?.touched) &&  unitForm.get('propertyTax')?.get('propertyTaxAmt')?.invalid }">

                                    <div *ngIf="(formSubmitted || unitForm.get('propertyTax')?.get('propertyTaxAmt')?.touched) && unitForm.get('propertyTax')?.get('propertyTaxAmt')?.invalid" class="invalid-feedback">

                                        <div *ngIf="unitForm.get('propertyTax')?.get('propertyTaxAmt')?.errors?.['required']">
                                    
                                            Property Tax Amt is required

                                        </div>
                                    
                                    </div>

                                </div>

                            </div>

                            <div class="col-md-4 ms-3">

                                <div class="form-group mb-3">
                                        
                                    <label for="dueDate" class="mb-2">Due Date</label>
                            
                                    <div class="input-group">
                                    
                                        <input type="text" class="form-control" [readOnly]="this.mode == 'Update'" id="dueDate" autocomplete="off" formControlName="dueDate" placeholder="Seledct Date" [matDatepicker]="picker" [ngClass]="{ 'is-invalid': (formSubmitted || unitForm.get('propertyTax')?.get('dueDate')?.touched) &&  unitForm.get('propertyTax')?.get('dueDate')?.invalid }"/>
                                
                                        <mat-datepicker-toggle matSuffix [for]="picker" class="input-group-text border" style="border-radius: 0px 5px 5px 0px !important; height: 38px">

                                            <ng-container matDatepickerToggleIcon>
                                                
                                                <i class="bi bi-calendar4-week fs-5 text-center"></i>
                                            
                                            </ng-container>
                                            
                                        </mat-datepicker-toggle>
                                
                                        <mat-datepicker #picker></mat-datepicker>

                                    </div>

                                    <div *ngIf="(formSubmitted || unitForm.get('propertyTax')?.get('dueDate')?.touched) && unitForm.get('propertyTax')?.get('dueDate')?.invalid" class="invalid-feedback">

                                        <div *ngIf="unitForm.get('propertyTax')?.get('dueDate')?.errors?.['required']">
                                    
                                            Due Date is required

                                        </div>
                                    
                                    </div>
                                
                                </div>

                            </div>
 
                            <div class="col-md-4 ms-3">

                                <div class="form-group mb-3">

                                    <label for="remindBefore" class="mb-2">Remind Before ( Days )</label>

                                    <input type="number" class="form-control" id="remindBefore" placeholder="Select Days" [readOnly]="this.mode == 'Update'" formControlName="remindBefore" numbersOnly>

                                </div>

                            </div>

                        </div>

                    </ng-container>
        
                </div>
    
            </div>

        </div> -->

        <!-- Property Tax List Table -->
        <div class="col-md-12" *ngIf="this.mode == 'Update'">

            <div class="card border-0 mt-3" style="box-shadow: 0 0 2px 2px rgba(0, 0, 0, 0.051);">

                <div class="card-header bg-white">
                            
                    <div class="d-flex justify-content-between align-items-center " style="height: 40px;">
        
                        <h6 class="ps-2 my-0" style="font-weight: 600; border-left: 3px solid #D2A119;">Property Tax History: </h6>
                        
                    </div>
                        
                </div>
    
                <div class="card-body p-0">
    
                    <div class="table-responsive">

                        <table class="table table-borderless align-middle table-striped">
    
                            <thead class="bg-light text-secondary">
    
                                <tr>
    
                                    <th style="max-width: 200px !important;">Due Date</th>

                                    <th style="max-width: 200px !important;">Payment Date</th>
                                    
                                    <th style="max-width: 200px !important;">Amount</th>
                                    
                                    <th style="text-align: start !important; min-width: 210px !important;">Status</th>

                                </tr>
    
                            </thead>
                        
                            <tbody>

                                <ng-container *ngFor="let propertyTax of this.masterList['propertyTaxList']">

                                    <ng-container *ngIf="!_.isEmpty(propertyTax.paymentEntries); else other">

                                        <tr *ngFor="let tax of propertyTax.paymentEntries; let i = index; let last = last; let first = first">

                                            <td>{{ tax.dueDate | date: 'dd-MM-yyyy' }}</td>

                                            <td>{{ tax.paymentDate | date: 'dd-MM-yyyy' }}</td>

                                            <td>{{ tax.amountPaid | number: '' }}</td>

                                            <td style="text-align: start !important; min-width: 210px !important;">

                                                <ng-container [ngSwitch]="getStatus(tax)">

                                                    <font *ngSwitchCase="'Overdue'" color="#C92E2E">Overdue</font>

                                                    <font *ngSwitchCase="'Upcoming'" color="#FFA500">Upcoming</font>

                                                    <font *ngSwitchCase="'Not yet Due'" color="#FF9500">Not yet Due</font>

                                                    <font *ngSwitchCase="'Paid'" color="#34C759">Paid</font>

                                                    <font *ngSwitchDefault>-</font>

                                                </ng-container>

                                            </td>

                                        </tr>
                
                                    </ng-container>

                                    <ng-template #other>

                                        <tr>

                                            <td colspan="10" style="text-align: center !important;">No Records Found</td>

                                        </tr>

                                    </ng-template>

                                </ng-container>
    
                            </tbody>

                        </table>

                    </div>
    
                </div>
    
            </div>

        </div>

        <!-- Buttons -->
        <div class="d-flex justify-content-end mt-3">

            <button class="btn btn-outline-secondary mt-3 px-3 ms-2 py-0 me-2" (click)="close()">Discard</button>
            
            <button class="btn btn-secondary mt-3 px-3 py-1" (click)="onSubmit()">Save</button>

        </div>

    </div>

</div>

<div class="file-modal" *ngIf="previewUrl" (click)="closePreview()">

  <ng-container *ngIf="isPdfPreview; else imagePreview">

    <iframe [src]="previewUrl" class="modal-file" frameborder="0" type="application/pdf"></iframe>

  </ng-container>

  <ng-template #imagePreview>

    <img [src]="previewUrl" class="modal-img"/>

  </ng-template>

</div>

<!-- Rent History Modal -->
<ng-template #detailHistoryModal let-modal>

    <div class="modal-header">

        <div class="d-flex justify-content-between align-items-center w-100" style="height: 40px;">

            <h6 class="ps-2 my-0" style="font-weight: 600; border-left: 3px solid #D2A119;">Rental List</h6>
            
            <i class="bi bi-x-lg pe-2 fw-bold" (click)="modal.close()"></i>
            
        </div>

    </div>

    <div class="modal-body">

        <div class="mt-3">

            <div class="table-responsive">

                <table class="table table-borderless align-middle table-striped">

                    <thead class="bg-light text-secondary">

                        <tr>

                            <th>Payment Date</th>

                            <th>Amount</th>

                            <th>Payment Mode</th>

                            <th>PDC</th>

                            <th>PDC Date</th>

                            <th>Bank</th>

                            <th>Bank Branch</th>

                            <th>Cheque No</th>

                        </tr>

                    </thead>
                
                    <tbody>

                        <ng-container *ngIf="!_.isEmpty(this.selectedData?.paymentEntries); else other">

                            <tr *ngFor="let rent of this.selectedData?.paymentEntries">

                                <td>{{ (rent.paymentDate | date: 'dd-MM-yyyy') || '-' }}</td>

                                <td>{{ this.service.currencyCode?.currencyCode }}. {{ (rent?.amountPaid) || '-' }}</td>

                                <td>{{ rent.paymentMode || '-' }}</td>
                                
                                <td>{{ (rent.isPdc == true ? 'Yes' : 'No') }}</td>

                                <td>{{ (rent.chequeDate | date: 'dd-MM-yyyy') || '' }}</td>

                                <td>{{ (rent.bank) || '-' }}</td>

                                <td>{{ rent.bankBranch || '-' }}</td>

                                <td>{{ rent.chequeNo || '-' }}</td>

                            </tr>

                        </ng-container>

                        <ng-template #other>

                            <tr>

                                <td colspan="10" style="text-align: center !important;">No Records Found</td>

                            </tr>

                        </ng-template>

                        <ng-template #other>

                            <tr>

                                <td colspan="11" style="width: 16px !important;"><img  class="me-2" src="images/lock2.png" alt="">Access Denied</td>

                            </tr>

                        </ng-template>

                    </tbody>

                </table>

            </div>

        </div>

    </div>

</ng-template>
